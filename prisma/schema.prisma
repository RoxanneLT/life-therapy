generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// CMS: Pages
// ============================================================
model Page {
  id          String        @id @default(cuid())
  title       String
  slug        String        @unique
  description String?
  isPublished Boolean       @default(false)
  sortOrder   Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  sections    PageSection[]

  @@map("pages")
}

// ============================================================
// CMS: Content blocks within a page
// ============================================================
model PageSection {
  id          String   @id @default(cuid())
  pageId      String
  page        Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)
  sectionType String   // hero, text, image_text, cta, testimonial_carousel, course_grid, features, faq
  title       String?
  subtitle    String?
  content     String?  @db.Text
  imageUrl    String?
  imageAlt    String?
  ctaText     String?
  ctaLink     String?
  config      Json?
  sortOrder   Int      @default(0)
  isVisible   Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([pageId])
  @@map("page_sections")
}

// ============================================================
// Course catalog
// ============================================================
model Course {
  id               String         @id @default(cuid())
  title            String
  slug             String         @unique
  subtitle         String?
  shortDescription String?
  description      String?        @db.Text
  imageUrl         String?
  price            Int            @default(0)  // ZAR cents (38900 = R389)
  priceUsd         Int?           // USD cents (e.g. 2499 = $24.99)
  priceEur         Int?           // EUR cents (e.g. 2299 = €22.99)
  priceGbp         Int?           // GBP cents (e.g. 1999 = £19.99)
  category         String?        // self_esteem, mental_wellness, relationships, specialised
  modulesCount     Int            @default(0)
  hours            String?        // e.g. "~6 Hours"
  level            String?        // Beginner, Intermediate, Advanced
  isPublished      Boolean        @default(false)
  isFeatured       Boolean        @default(false)
  sortOrder        Int            @default(0)
  previewVideoUrl  String?        // Sofia Hart intro video (YouTube/Vimeo/direct URL)
  facilitatorScript String?       @db.Text  // Script for Sofia Hart to introduce this course
  relatedCourseIds Json?          // Admin cross-sell overrides (array of course IDs)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  // LMS relations
  modules              Module[]
  enrollments          Enrollment[]
  certificates         Certificate[]
  orderItems           OrderItem[]
  gifts                Gift[]
  moduleAccess         ModuleAccess[]

  @@map("courses")
}

// ============================================================
// Testimonials
// ============================================================
model Testimonial {
  id          String   @id @default(cuid())
  name        String
  role        String?
  location    String?
  content     String   @db.Text
  rating      Int      @default(5)
  imageUrl    String?
  serviceType String   @default("session") // session, course
  isPublished Boolean  @default(false)
  isFeatured  Boolean  @default(false)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("testimonials")
}

// ============================================================
// Admin users (linked to Supabase Auth)
// ============================================================
enum AdminRole {
  super_admin
  editor
  marketing
}

model AdminUser {
  id             String    @id @default(cuid())
  supabaseUserId String    @unique
  email          String    @unique
  name           String?
  role           AdminRole @default(editor)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@map("admin_users")
}

// ============================================================
// Site-wide settings (single-row table)
// ============================================================
model SiteSetting {
  id                  String   @id @default(cuid())
  // Branding
  siteName            String   @default("Life-Therapy")
  tagline             String?  @db.Text
  logoUrl             String?
  // Contact
  email               String?
  phone               String?
  whatsappNumber      String?
  businessHours       Json?
  locationText        String?
  // Social Links
  facebookUrl         String?
  linkedinUrl         String?
  instagramUrl        String?
  tiktokUrl           String?
  youtubeUrl          String?
  // SEO
  metaTitle           String?
  metaDescription     String?  @db.Text
  ogImageUrl          String?
  googleAnalyticsId   String?
  // Email (SMTP)
  smtpHost            String?
  smtpPort            Int?
  smtpUser            String?
  smtpPass            String?
  smtpFromName        String?
  smtpFromEmail       String?
  // Footer
  copyrightText       String?  @db.Text
  footerTagline       String?  @db.Text
  // Booking Settings
  bookingMaxAdvanceDays  Int     @default(30)
  bookingMinNoticeHours  Int     @default(24)
  bookingBufferMinutes   Int     @default(15)
  bookingEnabled         Boolean @default(false)
  // Microsoft Graph (Exchange/Teams)
  msGraphTenantId        String?
  msGraphClientId        String?
  msGraphClientSecret    String?
  msGraphUserEmail       String?
  // Stripe
  stripeSecretKey        String?
  stripePublishableKey   String?
  stripeWebhookSecret    String?
  // Session Pricing (all currencies, cents)
  sessionPriceIndividualZar  Int?  @default(85000)  // R850.00
  sessionPriceIndividualUsd  Int?  @default(6500)   // $65.00
  sessionPriceIndividualEur  Int?  @default(5900)   // €59.00
  sessionPriceIndividualGbp  Int?  @default(4900)   // £49.00
  sessionPriceCouplesZar     Int?  @default(120000) // R1,200.00
  sessionPriceCouplesUsd     Int?  @default(9500)   // $95.00
  sessionPriceCouplesEur     Int?  @default(8500)   // €85.00
  sessionPriceCouplesGbp     Int?  @default(7500)   // £75.00
  // Timestamps
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("site_settings")
}

// ============================================================
// Booking System
// ============================================================
enum BookingStatus {
  pending
  confirmed
  cancelled
  completed
  no_show
}

enum SessionType {
  free_consultation
  individual
  couples
}

model Booking {
  id                 String        @id @default(cuid())
  sessionType        SessionType
  date               DateTime      @db.Date
  startTime          String
  endTime            String
  durationMinutes    Int
  priceZarCents      Int           @default(0)
  priceCurrency      String        @default("ZAR")
  clientName         String
  clientEmail        String
  clientPhone        String?
  clientNotes        String?       @db.Text
  status             BookingStatus @default(pending)
  adminNotes         String?       @db.Text
  graphEventId       String?
  teamsMeetingUrl    String?
  confirmationToken  String?       @unique
  confirmationSentAt DateTime?
  reminderSentAt     DateTime?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  @@index([date])
  @@index([status])
  @@index([clientEmail])
  @@map("bookings")
}

model AvailabilityOverride {
  id        String   @id @default(cuid())
  date      DateTime @db.Date
  isBlocked Boolean  @default(true)
  startTime String?
  endTime   String?
  reason    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([date])
  @@map("availability_overrides")
}

// ============================================================
// LMS Enums
// ============================================================
enum LectureType {
  video
  text
  quiz
}

enum QuestionType {
  multiple_choice
  true_false
  reflection
}

enum OrderStatus {
  pending
  paid
  failed
  refunded
  partially_refunded
}

enum EnrollmentSource {
  purchase
  gift
  admin_grant
  upgrade
}

enum CreditTransactionType {
  purchase
  used
  refund
  admin_grant
  gift_received
}

enum GiftStatus {
  pending
  delivered
  redeemed
  cancelled
}

enum CouponType {
  percentage
  fixed_amount
}

enum ContactSource {
  newsletter
  booking
  student
  import
  manual
}

enum CampaignStatus {
  draft
  sending
  sent
  failed
}

enum DripEmailType {
  onboarding
  newsletter
}

// ============================================================
// Students (linked to Supabase Auth, separate from AdminUser)
// ============================================================
model Student {
  id                 String    @id @default(cuid())
  supabaseUserId     String    @unique
  email              String    @unique
  firstName          String
  lastName           String
  avatarUrl          String?
  mustChangePassword Boolean   @default(false)
  emailOptOut        Boolean   @default(false)
  unsubscribeToken   String?   @unique @default(cuid())
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  enrollments          Enrollment[]
  moduleAccess           ModuleAccess[]
  digitalProductAccess   DigitalProductAccess[]
  lectureProgress        LectureProgress[]
  quizAttempts           QuizAttempt[]
  certificates           Certificate[]
  orders                 Order[]
  creditBalance          SessionCreditBalance?
  creditTransactions     SessionCreditTransaction[]
  cart                   Cart?
  notes                  StudentNote[]
  giftsGiven             Gift[]   @relation("GiftBuyer")
  giftsReceived          Gift[]   @relation("GiftRecipient")
  emailLogs              EmailLog[]
  contact                Contact?

  @@map("students")
}

// ============================================================
// LMS: Modules (belong to Course)
// ============================================================
model Module {
  id          String   @id @default(cuid())
  courseId    String
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  title       String
  description String?  @db.Text
  sortOrder   Int      @default(0)
  // Standalone selling fields (short courses)
  standaloneSlug         String?  @unique
  standaloneTitle        String?
  standaloneDescription  String?  @db.Text
  standaloneImageUrl     String?
  standalonePrice        Int?     // ZAR cents
  standalonePriceUsd     Int?     // USD cents
  standalonePriceEur     Int?     // EUR cents
  standalonePriceGbp     Int?     // GBP cents
  isStandalonePublished  Boolean  @default(false)
  standaloneCategory     String?
  // Preview video & facilitator
  previewVideoUrl        String?           // Sofia Hart intro video for this module
  facilitatorScript      String?  @db.Text // Script for Sofia Hart to introduce this module
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  lectures     Lecture[]
  quiz         Quiz?
  moduleAccess ModuleAccess[]
  gifts        Gift[]
  orderItems   OrderItem[]

  @@index([courseId])
  @@map("modules")
}

// ============================================================
// LMS: Lectures (belong to Module)
// ============================================================
model Lecture {
  id              String      @id @default(cuid())
  moduleId        String
  module          Module      @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  title           String
  lectureType     LectureType @default(video)
  videoUrl        String?
  textContent     String?     @db.Text
  worksheetUrl    String?
  durationSeconds Int?
  isPreview       Boolean     @default(false)
  context         String      @default("both") // "both" | "course_only" | "standalone_only"
  sortOrder       Int         @default(0)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  progress        LectureProgress[]
  notes           StudentNote[]

  @@index([moduleId])
  @@map("lectures")
}

// ============================================================
// LMS: Quizzes (one per Module)
// ============================================================
model Quiz {
  id           String   @id @default(cuid())
  moduleId     String   @unique
  module       Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  title        String
  description  String?  @db.Text
  passingScore Int      @default(70)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  questions    QuizQuestion[]
  attempts     QuizAttempt[]

  @@map("quizzes")
}

model QuizQuestion {
  id           String       @id @default(cuid())
  quizId       String
  quiz         Quiz         @relation(fields: [quizId], references: [id], onDelete: Cascade)
  questionType QuestionType
  questionText String       @db.Text
  options      Json?
  explanation  String?      @db.Text
  sortOrder    Int          @default(0)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([quizId])
  @@map("quiz_questions")
}

model QuizAttempt {
  id          String   @id @default(cuid())
  quizId      String
  quiz        Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  studentId   String
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  score       Int
  passed      Boolean
  answers     Json
  completedAt DateTime @default(now())

  @@index([quizId, studentId])
  @@map("quiz_attempts")
}

// ============================================================
// Enrollment & Progress
// ============================================================
model Enrollment {
  id              String           @id @default(cuid())
  studentId       String
  student         Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  courseId         String
  course          Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  source          EnrollmentSource @default(purchase)
  orderId         String?
  order           Order?           @relation(fields: [orderId], references: [id])
  giftId          String?
  progressPercent Float            @default(0)
  completedAt     DateTime?
  enrolledAt      DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@unique([studentId, courseId])
  @@index([studentId])
  @@index([courseId])
  @@map("enrollments")
}

// ============================================================
// Module Access (standalone short course purchases)
// ============================================================
model ModuleAccess {
  id        String           @id @default(cuid())
  studentId String
  student   Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  moduleId  String
  module    Module           @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  courseId   String
  course    Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  orderId   String?
  pricePaid Int              @default(0) // ZAR cents — for upgrade credit calculation
  source    EnrollmentSource @default(purchase)
  grantedAt DateTime         @default(now())

  @@unique([studentId, moduleId])
  @@index([studentId])
  @@index([moduleId])
  @@map("module_access")
}

model LectureProgress {
  id            String    @id @default(cuid())
  studentId     String
  student       Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  lectureId     String
  lecture        Lecture   @relation(fields: [lectureId], references: [id], onDelete: Cascade)
  completed     Boolean   @default(false)
  videoPosition Int       @default(0)
  completedAt   DateTime?
  updatedAt     DateTime  @updatedAt

  @@unique([studentId, lectureId])
  @@index([studentId])
  @@map("lecture_progress")
}

model Certificate {
  id                String   @id @default(cuid())
  studentId         String
  student           Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  courseId           String
  course            Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  certificateNumber String   @unique
  issuedAt          DateTime @default(now())

  @@unique([studentId, courseId])
  @@map("certificates")
}

model StudentNote {
  id        String   @id @default(cuid())
  studentId String
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  lectureId String
  lecture   Lecture   @relation(fields: [lectureId], references: [id], onDelete: Cascade)
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId, lectureId])
  @@map("student_notes")
}

// ============================================================
// E-Commerce: Orders
// ============================================================
model Order {
  id                  String      @id @default(cuid())
  orderNumber         String      @unique
  studentId           String
  student             Student     @relation(fields: [studentId], references: [id])
  status              OrderStatus @default(pending)
  subtotalCents       Int
  discountCents       Int         @default(0)
  totalCents          Int
  currency            String      @default("ZAR")
  couponId            String?
  coupon              Coupon?     @relation(fields: [couponId], references: [id])
  stripeSessionId     String?     @unique
  stripePaymentIntent String?     @unique
  paidAt              DateTime?
  refundedAt          DateTime?
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  items               OrderItem[]
  enrollments         Enrollment[]
  gifts               Gift[]

  @@index([studentId])
  @@index([status])
  @@map("orders")
}

model OrderItem {
  id                String          @id @default(cuid())
  orderId           String
  order             Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  courseId           String?
  course            Course?         @relation(fields: [courseId], references: [id])
  hybridPackageId   String?
  hybridPackage     HybridPackage?  @relation(fields: [hybridPackageId], references: [id])
  moduleId          String?
  module            Module?         @relation(fields: [moduleId], references: [id])
  digitalProductId  String?
  digitalProduct    DigitalProduct? @relation(fields: [digitalProductId], references: [id])
  packageSelections Json?           // { courseIds: string[], digitalProductIds: string[] }
  description       String
  unitPriceCents    Int
  quantity          Int             @default(1)
  totalCents        Int
  isGift            Boolean         @default(false)
  giftId            String?         @unique
  gift              Gift?           @relation(fields: [giftId], references: [id])

  @@index([orderId])
  @@map("order_items")
}

// ============================================================
// Gifting
// ============================================================
model Gift {
  id             String     @id @default(cuid())
  orderId        String
  order          Order      @relation(fields: [orderId], references: [id])
  buyerId        String
  buyer          Student    @relation("GiftBuyer", fields: [buyerId], references: [id])
  recipientId    String?
  recipient      Student?   @relation("GiftRecipient", fields: [recipientId], references: [id])
  recipientEmail String
  recipientName  String
  message        String?    @db.Text
  deliveryDate   DateTime?
  status         GiftStatus @default(pending)
  courseId          String?
  course            Course?         @relation(fields: [courseId], references: [id])
  hybridPackageId   String?
  hybridPackage     HybridPackage?  @relation(fields: [hybridPackageId], references: [id])
  moduleId          String?
  module            Module?         @relation(fields: [moduleId], references: [id])
  digitalProductId  String?
  digitalProduct    DigitalProduct? @relation(fields: [digitalProductId], references: [id])
  packageSelections Json?           // { courseIds: string[], digitalProductIds: string[] }
  creditAmount      Int?
  emailSentAt       DateTime?
  redeemedAt      DateTime?
  redeemToken     String     @unique @default(cuid())
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  orderItem       OrderItem?

  @@index([recipientEmail])
  @@index([status])
  @@map("gifts")
}

// ============================================================
// Session Credits
// ============================================================
model SessionCreditBalance {
  id        String  @id @default(cuid())
  studentId String  @unique
  student   Student @relation(fields: [studentId], references: [id], onDelete: Cascade)
  balance   Int     @default(0)

  @@map("session_credit_balances")
}

model SessionCreditTransaction {
  id           String                @id @default(cuid())
  studentId    String
  student      Student               @relation(fields: [studentId], references: [id], onDelete: Cascade)
  type         CreditTransactionType
  amount       Int
  balanceAfter Int
  description  String
  orderId      String?
  bookingId    String?
  createdAt    DateTime              @default(now())

  @@index([studentId])
  @@map("session_credit_transactions")
}

// ============================================================
// Coupons
// ============================================================
model Coupon {
  id             String     @id @default(cuid())
  code           String     @unique
  type           CouponType
  value          Int                        // ZAR cents (fixed_amount) or percentage
  valueUsd       Int?                       // USD cents (fixed_amount only)
  valueEur       Int?                       // EUR cents (fixed_amount only)
  valueGbp       Int?                       // GBP cents (fixed_amount only)
  appliesToAll   Boolean    @default(true)
  courseIds      Json?
  packageIds    Json?
  maxUses        Int?
  usedCount      Int        @default(0)
  maxUsesPerUser Int        @default(1)
  minOrderCents  Int?
  startsAt       DateTime   @default(now())
  expiresAt      DateTime?
  isActive       Boolean    @default(true)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  orders         Order[]

  @@map("coupons")
}

// ============================================================
// Shopping Cart (DB-persisted for logged-in students)
// ============================================================
model Cart {
  id        String     @id @default(cuid())
  studentId String     @unique
  student   Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  updatedAt DateTime   @updatedAt

  items     CartItem[]

  @@map("carts")
}

model CartItem {
  id                 String          @id @default(cuid())
  cartId             String
  cart               Cart            @relation(fields: [cartId], references: [id], onDelete: Cascade)
  courseId            String?
  hybridPackageId    String?
  moduleId           String?
  digitalProductId   String?
  digitalProduct     DigitalProduct? @relation(fields: [digitalProductId], references: [id])
  packageSelections  Json?           // { courseIds: string[], digitalProductIds: string[] }
  quantity           Int             @default(1)
  isGift             Boolean         @default(false)
  giftRecipientName  String?
  giftRecipientEmail String?
  giftMessage        String?         @db.Text
  giftDeliveryDate   DateTime?
  addedAt            DateTime        @default(now())

  @@index([cartId])
  @@map("cart_items")
}

// ============================================================
// Packages (unified: course bundles, credit packs, hybrids, digital docs)
// ============================================================
model HybridPackage {
  id                  String   @id @default(cuid())
  title               String
  slug                String   @unique
  description         String?  @db.Text
  imageUrl            String?
  priceCents          Int
  priceCentsUsd       Int?
  priceCentsEur       Int?
  priceCentsGbp       Int?
  credits             Int      @default(0)
  courseSlots          Int      @default(0) // How many full courses the customer picks
  digitalProductSlots Int      @default(0) // How many digital products the customer picks
  isPublished         Boolean  @default(false)
  sortOrder           Int      @default(0)
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  orderItems  OrderItem[]
  gifts       Gift[]

  @@map("hybrid_packages")
}

// ============================================================
// Digital Products (downloadable files: PDFs, workbooks, etc.)
// ============================================================
model DigitalProduct {
  id             String   @id @default(cuid())
  title          String
  slug           String   @unique
  description    String?  @db.Text
  imageUrl       String?
  fileUrl        String   // Private Supabase Storage path (e.g. "products/abc123.pdf")
  fileName       String?  // Original filename for display
  fileSizeBytes  Int?     // File size in bytes
  priceCents     Int      @default(0)  // ZAR cents
  priceCentsUsd  Int?     // USD cents
  priceCentsEur  Int?     // EUR cents
  priceCentsGbp  Int?     // GBP cents
  category       String?  // workbook, toolkit, guide, journal, cheat_sheet (for future filtering)
  isPublished    Boolean  @default(false)
  sortOrder      Int      @default(0)
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  access     DigitalProductAccess[]
  orderItems OrderItem[]
  gifts      Gift[]
  cartItems  CartItem[]

  @@map("digital_products")
}

// ============================================================
// Digital Product Access (tracks student ownership)
// ============================================================
model DigitalProductAccess {
  id               String           @id @default(cuid())
  studentId        String
  student          Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  digitalProductId String
  digitalProduct   DigitalProduct   @relation(fields: [digitalProductId], references: [id], onDelete: Cascade)
  orderId          String?
  source           EnrollmentSource @default(purchase)
  grantedAt        DateTime         @default(now())

  @@unique([studentId, digitalProductId])
  @@index([studentId])
  @@index([digitalProductId])
  @@map("digital_product_access")
}

// ============================================================
// Email Templates (admin-editable, DB-stored)
// ============================================================
model EmailTemplate {
  id        String   @id @default(cuid())
  key       String   @unique // "booking_confirmation", "order_confirmation", etc.
  name      String           // Human-readable name
  category  String           // "booking" | "order" | "onboarding" | "course" | "gift"
  subject   String           // Subject line with {{variable}} placeholders
  bodyHtml  String   @db.Text // Inner HTML body with {{variable}} placeholders
  variables Json             // Array of available variable names
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("email_templates")
}

// ============================================================
// Email Delivery Log
// ============================================================
model EmailLog {
  id           String   @id @default(cuid())
  templateKey  String?  // e.g. "booking_confirmation"
  to           String
  subject      String
  status       String   // "sent" | "failed"
  error        String?  @db.Text
  studentId    String?
  student      Student? @relation(fields: [studentId], references: [id], onDelete: SetNull)
  metadata     Json?    // Extra context: bookingId, orderId, giftId, etc.
  sentAt       DateTime @default(now())

  @@index([to])
  @@index([templateKey])
  @@index([studentId])
  @@index([sentAt])
  @@map("email_logs")
}

// ============================================================
// Contact Management (unified mailing list)
// ============================================================
model Contact {
  id               String        @id @default(cuid())
  email            String        @unique
  firstName        String?
  lastName         String?
  phone            String?
  gender           String?
  source           ContactSource @default(newsletter)
  tags             Json?
  consentGiven     Boolean       @default(false)
  consentDate      DateTime?
  consentMethod    String?
  emailOptOut      Boolean       @default(false)
  unsubscribeToken String        @unique @default(cuid())
  studentId        String?       @unique
  student          Student?      @relation(fields: [studentId], references: [id], onDelete: SetNull)
  notes            String?       @db.Text
  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt
  dripProgress     DripProgress?

  @@index([source])
  @@index([emailOptOut])
  @@map("contacts")
}

// ============================================================
// Campaigns (email broadcasts)
// ============================================================
model Campaign {
  id              String         @id @default(cuid())
  name            String
  subject         String
  bodyHtml        String         @db.Text
  status          CampaignStatus @default(draft)
  filterSource    String?
  filterTags      Json?
  totalRecipients Int            @default(0)
  sentCount       Int            @default(0)
  failedCount     Int            @default(0)
  sentAt          DateTime?
  sentById        String?
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt

  @@index([status])
  @@map("campaigns")
}

// ============================================================
// Drip Emails (automated nurture sequence)
// ============================================================
model DripEmail {
  id          String        @id @default(cuid())
  type        DripEmailType
  step        Int
  dayOffset   Int
  subject     String
  previewText String?
  bodyHtml    String        @db.Text
  ctaText     String?
  ctaUrl      String?
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@unique([type, step])
  @@index([type])
  @@map("drip_emails")
}

model DripProgress {
  id           String        @id @default(cuid())
  contactId    String        @unique
  contact      Contact       @relation(fields: [contactId], references: [id], onDelete: Cascade)
  currentPhase DripEmailType @default(onboarding)
  currentStep  Int           @default(0)
  lastSentAt   DateTime?
  completedAt  DateTime?
  isPaused     Boolean       @default(false)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([currentPhase, currentStep])
  @@index([isPaused])
  @@map("drip_progress")
}

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// CMS: Pages
// ============================================================
model Page {
  id          String        @id @default(cuid())
  title       String
  slug        String        @unique
  description String?
  isPublished Boolean       @default(false)
  sortOrder   Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  sections    PageSection[]

  @@map("pages")
}

// ============================================================
// CMS: Content blocks within a page
// ============================================================
model PageSection {
  id          String   @id @default(cuid())
  pageId      String
  page        Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)
  sectionType String   // hero, text, image_text, cta, testimonial_carousel, course_grid, features, faq
  title       String?
  subtitle    String?
  content     String?  @db.Text
  imageUrl    String?
  imageAlt    String?
  ctaText     String?
  ctaLink     String?
  config      Json?
  sortOrder   Int      @default(0)
  isVisible   Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([pageId])
  @@map("page_sections")
}

// ============================================================
// Course catalog
// ============================================================
model Course {
  id               String         @id @default(cuid())
  title            String
  slug             String         @unique
  subtitle         String?
  shortDescription String?
  description      String?        @db.Text
  imageUrl         String?
  price            Int            @default(0)  // ZAR cents (38900 = R389)
  category         String?        // self_esteem, mental_wellness, relationships, specialised
  modulesCount     Int            @default(0)
  hours            String?        // e.g. "~6 Hours"
  level            String?        // Beginner, Intermediate, Advanced
  isPublished      Boolean        @default(false)
  isFeatured       Boolean        @default(false)
  sortOrder        Int            @default(0)
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  bundleCourses    BundleCourse[]

  @@map("courses")
}

// ============================================================
// Course bundles
// ============================================================
model Bundle {
  id            String         @id @default(cuid())
  title         String
  slug          String         @unique
  description   String?        @db.Text
  bestFor       String?
  imageUrl      String?
  price         Int            @default(0)  // ZAR cents
  isPublished   Boolean        @default(false)
  sortOrder     Int            @default(0)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt
  bundleCourses BundleCourse[]

  @@map("bundles")
}

model BundleCourse {
  id        String @id @default(cuid())
  bundleId  String
  courseId   String
  sortOrder Int    @default(0)
  bundle    Bundle @relation(fields: [bundleId], references: [id], onDelete: Cascade)
  course    Course @relation(fields: [courseId], references: [id], onDelete: Cascade)

  @@unique([bundleId, courseId])
  @@map("bundle_courses")
}

// ============================================================
// Testimonials
// ============================================================
model Testimonial {
  id          String   @id @default(cuid())
  name        String
  role        String?
  location    String?
  content     String   @db.Text
  rating      Int      @default(5)
  imageUrl    String?
  serviceType String   @default("session") // session, course
  isPublished Boolean  @default(false)
  isFeatured  Boolean  @default(false)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("testimonials")
}

// ============================================================
// Admin users (linked to Supabase Auth)
// ============================================================
enum AdminRole {
  super_admin
  editor
  marketing
}

model AdminUser {
  id             String    @id @default(cuid())
  supabaseUserId String    @unique
  email          String    @unique
  name           String?
  role           AdminRole @default(editor)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@map("admin_users")
}

// ============================================================
// Site-wide settings (single-row table)
// ============================================================
model SiteSetting {
  id                  String   @id @default(cuid())
  // Branding
  siteName            String   @default("Life-Therapy")
  tagline             String?  @db.Text
  logoUrl             String?
  // Contact
  email               String?
  phone               String?
  whatsappNumber      String?
  businessHours       Json?
  locationText        String?
  // Social Links
  facebookUrl         String?
  linkedinUrl         String?
  instagramUrl        String?
  tiktokUrl           String?
  youtubeUrl          String?
  // SEO
  metaTitle           String?
  metaDescription     String?  @db.Text
  ogImageUrl          String?
  googleAnalyticsId   String?
  // Newsletter (Mailchimp)
  mailchimpApiKey     String?
  mailchimpAudienceId String?
  mailchimpServer     String?
  // Email (SMTP)
  smtpHost            String?
  smtpPort            Int?
  smtpUser            String?
  smtpPass            String?
  smtpFromName        String?
  smtpFromEmail       String?
  // Footer
  copyrightText       String?  @db.Text
  footerTagline       String?  @db.Text
  // Booking Settings
  bookingMaxAdvanceDays  Int     @default(30)
  bookingMinNoticeHours  Int     @default(24)
  bookingBufferMinutes   Int     @default(15)
  bookingEnabled         Boolean @default(false)
  // Microsoft Graph (Exchange/Teams)
  msGraphTenantId        String?
  msGraphClientId        String?
  msGraphClientSecret    String?
  msGraphUserEmail       String?
  // Timestamps
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("site_settings")
}

// ============================================================
// Booking System
// ============================================================
enum BookingStatus {
  pending
  confirmed
  cancelled
  completed
  no_show
}

enum SessionType {
  free_consultation
  individual
  couples
}

model Booking {
  id                 String        @id @default(cuid())
  sessionType        SessionType
  date               DateTime      @db.Date
  startTime          String
  endTime            String
  durationMinutes    Int
  priceZarCents      Int           @default(0)
  clientName         String
  clientEmail        String
  clientPhone        String?
  clientNotes        String?       @db.Text
  status             BookingStatus @default(pending)
  adminNotes         String?       @db.Text
  graphEventId       String?
  teamsMeetingUrl    String?
  confirmationToken  String?       @unique
  confirmationSentAt DateTime?
  reminderSentAt     DateTime?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  @@index([date])
  @@index([status])
  @@index([clientEmail])
  @@map("bookings")
}

model AvailabilityOverride {
  id        String   @id @default(cuid())
  date      DateTime @db.Date
  isBlocked Boolean  @default(true)
  startTime String?
  endTime   String?
  reason    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([date])
  @@map("availability_overrides")
}

generator client {
  provider = "prisma-client"
  output   = "../lib/generated/prisma"
}

datasource db {
  provider = "postgresql"
}

// ============================================================
// CMS: Pages
// ============================================================
model Page {
  id          String        @id @default(cuid())
  title       String
  slug        String        @unique
  description String?
  isPublished Boolean       @default(false)
  sortOrder   Int           @default(0)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt
  sections    PageSection[]

  @@map("pages")
}

// ============================================================
// CMS: Content blocks within a page
// ============================================================
model PageSection {
  id          String   @id @default(cuid())
  pageId      String
  page        Page     @relation(fields: [pageId], references: [id], onDelete: Cascade)
  sectionType String   // hero, text, image_text, cta, testimonial_carousel, course_grid, features, faq
  title       String?
  subtitle    String?
  content     String?  @db.Text
  imageUrl    String?
  imageAlt    String?
  ctaText     String?
  ctaLink     String?
  config      Json?
  sortOrder   Int      @default(0)
  isVisible   Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([pageId])
  @@map("page_sections")
}

// ============================================================
// Course catalog
// ============================================================
model Course {
  id               String         @id @default(cuid())
  title            String
  slug             String         @unique
  subtitle         String?
  shortDescription String?
  description      String?        @db.Text
  imageUrl         String?
  price            Int            @default(0)  // ZAR cents (38900 = R389)
  priceUsd         Int?           // USD cents (e.g. 2499 = $24.99)
  priceEur         Int?           // EUR cents (e.g. 2299 = €22.99)
  priceGbp         Int?           // GBP cents (e.g. 1999 = £19.99)
  category         String?        // self_esteem, mental_wellness, relationships, specialised
  modulesCount     Int            @default(0)
  hours            String?        // e.g. "~6 Hours"
  level            String?        // Beginner, Intermediate, Advanced
  isPublished      Boolean        @default(false)
  isFeatured       Boolean        @default(false)
  sortOrder        Int            @default(0)
  previewVideoUrl  String?        // Sofia Hart intro video (YouTube/Vimeo/direct URL)
  facilitatorScript String?       @db.Text  // Script for Sofia Hart to introduce this course
  relatedCourseIds Json?          // Admin cross-sell overrides (array of course IDs)
  metaTitle        String?        // SEO: override for <title> tag
  metaDescription  String?        @db.Text  // SEO: override for meta description
  createdAt        DateTime       @default(now())
  updatedAt        DateTime       @updatedAt
  // LMS relations
  modules              Module[]
  enrollments          Enrollment[]
  certificates         Certificate[]
  orderItems           OrderItem[]
  gifts                Gift[]
  moduleAccess         ModuleAccess[]

  @@map("courses")
}

// ============================================================
// Testimonials
// ============================================================
model Testimonial {
  id          String   @id @default(cuid())
  name        String
  role        String?
  location    String?
  content     String   @db.Text
  rating      Int      @default(5)
  imageUrl    String?
  serviceType String   @default("session") // session, course
  isPublished Boolean  @default(false)
  isFeatured  Boolean  @default(false)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("testimonials")
}

// ============================================================
// Admin users (linked to Supabase Auth)
// ============================================================
enum AdminRole {
  super_admin
  editor
  marketing
}

model AdminUser {
  id             String    @id @default(cuid())
  supabaseUserId String    @unique
  email          String    @unique
  name           String?
  role           AdminRole @default(editor)
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  @@map("admin_users")
}

// ============================================================
// Site-wide settings (single-row table)
// ============================================================
model SiteSetting {
  id                  String   @id @default(cuid())
  // Branding
  siteName            String   @default("Life-Therapy")
  tagline             String?  @db.Text
  logoUrl             String?
  // Contact
  email               String?
  phone               String?
  whatsappNumber      String?
  businessHours       Json?
  locationText        String?
  // Social Links
  facebookUrl         String?
  linkedinUrl         String?
  instagramUrl        String?
  tiktokUrl           String?
  youtubeUrl          String?
  // SEO
  metaTitle           String?
  metaDescription     String?  @db.Text
  ogImageUrl          String?
  googleAnalyticsId   String?
  // Email (display preferences — credentials moved to env vars)
  smtpFromName        String?
  smtpFromEmail       String?
  // Footer
  copyrightText       String?  @db.Text
  footerTagline       String?  @db.Text
  // Booking Settings
  bookingMaxAdvanceDays  Int     @default(30)
  bookingMinNoticeHours  Int     @default(24)
  bookingBufferMinutes   Int     @default(15)
  bookingEnabled         Boolean @default(false)
  // Note: MS Graph, SMTP, Stripe/Paystack credentials moved to env vars
  // Session Pricing (all currencies, cents)
  sessionPriceIndividualZar  Int?  @default(85000)  // R850.00
  sessionPriceIndividualUsd  Int?  @default(6500)   // $65.00
  sessionPriceIndividualEur  Int?  @default(5900)   // €59.00
  sessionPriceIndividualGbp  Int?  @default(4900)   // £49.00
  sessionPriceCouplesZar     Int?  @default(120000) // R1,200.00
  sessionPriceCouplesUsd     Int?  @default(9500)   // $95.00
  sessionPriceCouplesEur     Int?  @default(8500)   // €85.00
  sessionPriceCouplesGbp     Int?  @default(7500)   // £75.00
  // Finance / Invoice settings
  businessRegistrationNumber String?  @default("2019/570691/07")
  invoicePrefix              String?  @default("LT")
  vatRegistered              Boolean  @default(false)
  vatNumber                  String?
  vatPercent                 Float    @default(15)
  bankName                   String?
  bankAccountHolder          String?
  bankAccountNumber          String?
  bankBranchCode             String?
  postpaidBillingDay         Int      @default(20)
  postpaidDueDay             Int      @default(28)
  businessAddress            String?  @db.Text
  // WhatsApp Cloud API
  whatsappEnabled           Boolean  @default(false)
  whatsappPhoneNumberId     String?
  whatsappBusinessAccountId String?
  whatsappSessionReminders  Boolean  @default(true)
  whatsappBillingReminders  Boolean  @default(true)
  whatsappCreditReminders   Boolean  @default(true)
  // Credit expiry
  creditExpiryDays          Int?
  // Timestamps
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  @@map("site_settings")
}

// ============================================================
// Invoice Numbering (global atomic counter)
// ============================================================
model InvoiceSequence {
  id         String @id @default("global")
  nextNumber Int    @default(1)

  @@map("invoice_sequences")
}

// ============================================================
// Booking System
// ============================================================
enum BookingStatus {
  pending
  confirmed
  cancelled
  completed
  no_show
}

enum SessionType {
  free_consultation
  individual
  couples
}

model Booking {
  id                 String        @id @default(cuid())
  sessionType        SessionType
  date               DateTime      @db.Date
  startTime          String
  endTime            String
  durationMinutes    Int
  priceZarCents      Int           @default(0)
  priceCurrency      String        @default("ZAR")
  clientName         String
  clientEmail        String
  clientPhone        String?
  clientNotes        String?       @db.Text
  status             BookingStatus @default(pending)
  adminNotes         String?       @db.Text
  graphEventId       String?
  teamsMeetingUrl    String?
  confirmationToken  String?       @unique
  confirmationSentAt DateTime?
  reminderSentAt     DateTime?
  createdAt          DateTime      @default(now())
  updatedAt          DateTime      @updatedAt

  // Link to student (null for walk-in/unregistered bookings)
  studentId              String?
  student                Student?  @relation(fields: [studentId], references: [id], onDelete: SetNull)

  // Reschedule tracking (anti-abuse)
  originalDate           DateTime? @db.Date
  originalStartTime      String?
  rescheduledAt          DateTime?
  rescheduleCount        Int       @default(0)

  // Cancellation tracking
  cancelledAt            DateTime?
  cancelledBy            String?   // "client" | "admin"
  cancellationReason     String?
  creditRefunded         Boolean   @default(false)
  isLateCancel           Boolean   @default(false)

  // Recurring series
  recurringSeriesId      String?
  recurringPattern       String?   // "weekly" | "bimonthly" | "monthly"

  // Invoicing links
  invoiceId              String?
  invoice                Invoice?        @relation(fields: [invoiceId], references: [id], onDelete: SetNull)
  paymentRequestId       String?
  paymentRequest         PaymentRequest? @relation(fields: [paymentRequestId], references: [id], onDelete: SetNull)
  billingNote            String?         // "(no-show)" | "(rescheduled)" | "(cancelled)" | null
  couplesPartnerName     String?         // Partner name for couples sessions
  // Admin policy override — allows client to reschedule/cancel outside normal windows
  policyOverride     Boolean   @default(false)

  // WhatsApp reminders
  whatsappReminder48hSentAt     DateTime?
  whatsappReminderMorningSentAt DateTime?

  @@index([date])
  @@index([status])
  @@index([clientEmail])
  @@index([studentId])
  @@index([recurringSeriesId])
  @@index([invoiceId])
  @@index([paymentRequestId])
  @@map("bookings")
}

model AvailabilityOverride {
  id        String   @id @default(cuid())
  date      DateTime @db.Date
  isBlocked Boolean  @default(true)
  startTime String?
  endTime   String?
  reason    String?
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([date])
  @@map("availability_overrides")
}

// ============================================================
// LMS Enums
// ============================================================
enum LectureType {
  video
  text
  quiz
}

enum QuestionType {
  multiple_choice
  true_false
  reflection
}

enum OrderStatus {
  pending
  paid
  failed
  refunded
  partially_refunded
}

enum EnrollmentSource {
  purchase
  gift
  admin_grant
  upgrade
}

enum CreditTransactionType {
  purchase
  used
  refund
  admin_grant
  gift_received
}

enum GiftStatus {
  pending
  delivered
  redeemed
  cancelled
}

enum CouponType {
  percentage
  fixed_amount
}

enum CampaignStatus {
  draft
  scheduled
  active
  sending
  sent
  completed
  paused
  failed
}

enum DripEmailType {
  onboarding
  newsletter
}

// ============================================================
// Students (linked to Supabase Auth, separate from AdminUser)
// ============================================================
model Student {
  id                 String    @id @default(cuid())
  supabaseUserId     String?   @unique
  email              String    @unique
  firstName          String
  lastName           String
  avatarUrl          String?
  mustChangePassword Boolean   @default(false)
  emailOptOut        Boolean   @default(false)
  unsubscribeToken   String?   @unique @default(cuid())
  createdAt          DateTime  @default(now())
  updatedAt          DateTime  @updatedAt

  // Extended profile
  dateOfBirth        DateTime?  @db.Date
  gender             String?
  phone              String?
  address            String?    @db.Text
  relationshipStatus String?
  emergencyContact   String?
  referralSource     String?
  referralDetail     String?

  // Onboarding tracking
  onboardingStep     Int        @default(0) // 0=not started, 1=details done, 2=assessment done, 3=commitment done
  profileCompletedAt DateTime?

  // Client lifecycle (merged from Contact)
  clientStatus       String     @default("potential") // "potential" | "active" | "inactive" | "archived"
  convertedAt        DateTime?
  convertedBy        String?

  // Source & tags (merged from Contact)
  source             String     @default("booking") // "newsletter" | "booking" | "import" | "manual" | "website"
  tags               Json?

  // Communication preferences (merged from Contact)
  emailPaused        Boolean    @default(false)
  emailPausedAt      DateTime?
  emailPauseReason   String?
  newsletterOptIn    Boolean    @default(true)
  marketingOptIn     Boolean    @default(true)
  smsOptIn           Boolean    @default(false)
  sessionReminders   Boolean    @default(true)
  consentGiven       Boolean    @default(false)
  consentDate        DateTime?
  consentMethod      String?

  // Admin notes
  adminNotes         String?    @db.Text

  // Billing
  billingType             String     @default("prepaid")   // "prepaid" | "postpaid"
  billingEmail            String?                           // Overrides email for invoice delivery
  billingAddress          String?    @db.Text               // Shown on invoice
  standingDiscountPercent Float?                            // e.g. 10.0 for 10% off every line item
  standingDiscountFixed   Int?                              // Fixed discount in cents per line item

  // Per-session-type billing assignment
  // Points to a ClientRelationship whose studentId (the payer) receives invoices
  individualBilledToId     String?
  individualBilledTo       ClientRelationship? @relation("IndividualBilledTo", fields: [individualBilledToId], references: [id], onDelete: SetNull)
  couplesBilledToId        String?
  couplesBilledTo          ClientRelationship? @relation("CouplesBilledTo", fields: [couplesBilledToId], references: [id], onDelete: SetNull)

  enrollments            Enrollment[]
  moduleAccess           ModuleAccess[]
  digitalProductAccess   DigitalProductAccess[]
  lectureProgress        LectureProgress[]
  quizAttempts           QuizAttempt[]
  certificates           Certificate[]
  orders                 Order[]
  creditBalance          SessionCreditBalance?
  creditTransactions     SessionCreditTransaction[]
  cart                   Cart?
  notes                  StudentNote[]
  giftsGiven             Gift[]   @relation("GiftBuyer")
  giftsReceived          Gift[]   @relation("GiftRecipient")
  emailLogs              EmailLog[]
  intake                 ClientIntake?
  commitmentAcks         CommitmentAcknowledgement[]
  documentAcceptances    DocumentAcceptance[]
  bookings               Booking[]
  dripProgress           DripProgress?
  campaignProgress       CampaignProgress[]
  relationshipsFrom      ClientRelationship[] @relation("RelationshipsFrom")
  relationshipsTo        ClientRelationship[] @relation("RelationshipsTo")
  invitesSent            RelationshipInvite[] @relation("InvitesSent")
  invitesReceived        RelationshipInvite[] @relation("InvitesReceived")
  invoices               Invoice[]
  paymentRequests        PaymentRequest[]
  whatsappLogs           WhatsAppLog[]

  @@index([clientStatus])
  @@index([source])
  @@map("students")
}

// ============================================================
// LMS: Modules (belong to Course)
// ============================================================
model Module {
  id          String   @id @default(cuid())
  courseId    String
  course      Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  title       String
  description String?  @db.Text
  sortOrder   Int      @default(0)
  // Standalone selling fields (short courses)
  standaloneSlug         String?  @unique
  standaloneTitle        String?
  standaloneDescription  String?  @db.Text
  standaloneImageUrl     String?
  standalonePrice        Int?     // ZAR cents
  standalonePriceUsd     Int?     // USD cents
  standalonePriceEur     Int?     // EUR cents
  standalonePriceGbp     Int?     // GBP cents
  isStandalonePublished  Boolean  @default(false)
  standaloneCategory     String?
  // Preview video & facilitator
  previewVideoUrl        String?           // Sofia Hart intro video for this module
  facilitatorScript      String?  @db.Text // Script for Sofia Hart to introduce this module
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  lectures     Lecture[]
  quiz         Quiz?
  moduleAccess ModuleAccess[]
  gifts        Gift[]
  orderItems   OrderItem[]

  @@index([courseId])
  @@map("modules")
}

// ============================================================
// LMS: Lectures (belong to Module)
// ============================================================
model Lecture {
  id              String      @id @default(cuid())
  moduleId        String
  module          Module      @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  title           String
  lectureType     LectureType @default(video)
  videoUrl        String?
  textContent     String?     @db.Text
  worksheetUrl    String?
  durationSeconds Int?
  isPreview       Boolean     @default(false)
  context         String      @default("both") // "both" | "course_only" | "standalone_only"
  sortOrder       Int         @default(0)
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt

  progress        LectureProgress[]
  notes           StudentNote[]

  @@index([moduleId])
  @@map("lectures")
}

// ============================================================
// LMS: Quizzes (one per Module)
// ============================================================
model Quiz {
  id           String   @id @default(cuid())
  moduleId     String   @unique
  module       Module   @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  title        String
  description  String?  @db.Text
  passingScore Int      @default(70)
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt

  questions    QuizQuestion[]
  attempts     QuizAttempt[]

  @@map("quizzes")
}

model QuizQuestion {
  id           String       @id @default(cuid())
  quizId       String
  quiz         Quiz         @relation(fields: [quizId], references: [id], onDelete: Cascade)
  questionType QuestionType
  questionText String       @db.Text
  options      Json?
  explanation  String?      @db.Text
  sortOrder    Int          @default(0)
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  @@index([quizId])
  @@map("quiz_questions")
}

model QuizAttempt {
  id          String   @id @default(cuid())
  quizId      String
  quiz        Quiz     @relation(fields: [quizId], references: [id], onDelete: Cascade)
  studentId   String
  student     Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  score       Int
  passed      Boolean
  answers     Json
  completedAt DateTime @default(now())

  @@index([quizId, studentId])
  @@map("quiz_attempts")
}

// ============================================================
// Enrollment & Progress
// ============================================================
model Enrollment {
  id              String           @id @default(cuid())
  studentId       String
  student         Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  courseId         String
  course          Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  source          EnrollmentSource @default(purchase)
  orderId         String?
  order           Order?           @relation(fields: [orderId], references: [id])
  giftId          String?
  progressPercent Float            @default(0)
  completedAt     DateTime?
  enrolledAt      DateTime         @default(now())
  updatedAt       DateTime         @updatedAt

  @@unique([studentId, courseId])
  @@index([studentId])
  @@index([courseId])
  @@map("enrollments")
}

// ============================================================
// Module Access (standalone short course purchases)
// ============================================================
model ModuleAccess {
  id        String           @id @default(cuid())
  studentId String
  student   Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  moduleId  String
  module    Module           @relation(fields: [moduleId], references: [id], onDelete: Cascade)
  courseId   String
  course    Course           @relation(fields: [courseId], references: [id], onDelete: Cascade)
  orderId   String?
  pricePaid Int              @default(0) // ZAR cents — for upgrade credit calculation
  source    EnrollmentSource @default(purchase)
  grantedAt DateTime         @default(now())

  @@unique([studentId, moduleId])
  @@index([studentId])
  @@index([moduleId])
  @@map("module_access")
}

model LectureProgress {
  id            String    @id @default(cuid())
  studentId     String
  student       Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  lectureId     String
  lecture        Lecture   @relation(fields: [lectureId], references: [id], onDelete: Cascade)
  completed     Boolean   @default(false)
  videoPosition Int       @default(0)
  completedAt   DateTime?
  updatedAt     DateTime  @updatedAt

  @@unique([studentId, lectureId])
  @@index([studentId])
  @@map("lecture_progress")
}

model Certificate {
  id                String   @id @default(cuid())
  studentId         String
  student           Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  courseId           String
  course            Course   @relation(fields: [courseId], references: [id], onDelete: Cascade)
  certificateNumber String   @unique
  issuedAt          DateTime @default(now())

  @@unique([studentId, courseId])
  @@map("certificates")
}

model StudentNote {
  id        String   @id @default(cuid())
  studentId String
  student   Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  lectureId String
  lecture   Lecture   @relation(fields: [lectureId], references: [id], onDelete: Cascade)
  content   String   @db.Text
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([studentId, lectureId])
  @@map("student_notes")
}

// ============================================================
// E-Commerce: Orders
// ============================================================
model Order {
  id                  String      @id @default(cuid())
  orderNumber         String      @unique
  studentId           String
  student             Student     @relation(fields: [studentId], references: [id])
  status              OrderStatus @default(pending)
  subtotalCents       Int
  discountCents       Int         @default(0)
  totalCents          Int
  currency            String      @default("ZAR")
  couponId            String?
  coupon              Coupon?     @relation(fields: [couponId], references: [id])
  paystackReference   String?     @unique
  paystackAccessCode  String?
  paidAt              DateTime?
  refundedAt          DateTime?
  createdAt           DateTime    @default(now())
  updatedAt           DateTime    @updatedAt

  items               OrderItem[]
  enrollments         Enrollment[]
  gifts               Gift[]

  @@index([studentId])
  @@index([status])
  @@map("orders")
}

model OrderItem {
  id                String          @id @default(cuid())
  orderId           String
  order             Order           @relation(fields: [orderId], references: [id], onDelete: Cascade)
  courseId           String?
  course            Course?         @relation(fields: [courseId], references: [id])
  hybridPackageId   String?
  hybridPackage     HybridPackage?  @relation(fields: [hybridPackageId], references: [id])
  moduleId          String?
  module            Module?         @relation(fields: [moduleId], references: [id])
  digitalProductId  String?
  digitalProduct    DigitalProduct? @relation(fields: [digitalProductId], references: [id])
  packageSelections Json?           // { courseIds: string[], digitalProductIds: string[] }
  description       String
  unitPriceCents    Int
  quantity          Int             @default(1)
  totalCents        Int
  isGift            Boolean         @default(false)
  giftId            String?         @unique
  gift              Gift?           @relation(fields: [giftId], references: [id])

  @@index([orderId])
  @@map("order_items")
}

// ============================================================
// Gifting
// ============================================================
model Gift {
  id             String     @id @default(cuid())
  orderId        String
  order          Order      @relation(fields: [orderId], references: [id])
  buyerId        String
  buyer          Student    @relation("GiftBuyer", fields: [buyerId], references: [id])
  recipientId    String?
  recipient      Student?   @relation("GiftRecipient", fields: [recipientId], references: [id])
  recipientEmail String
  recipientName  String
  message        String?    @db.Text
  deliveryDate   DateTime?
  status         GiftStatus @default(pending)
  courseId          String?
  course            Course?         @relation(fields: [courseId], references: [id])
  hybridPackageId   String?
  hybridPackage     HybridPackage?  @relation(fields: [hybridPackageId], references: [id])
  moduleId          String?
  module            Module?         @relation(fields: [moduleId], references: [id])
  digitalProductId  String?
  digitalProduct    DigitalProduct? @relation(fields: [digitalProductId], references: [id])
  packageSelections Json?           // { courseIds: string[], digitalProductIds: string[] }
  creditAmount      Int?
  emailSentAt       DateTime?
  redeemedAt      DateTime?
  redeemToken     String     @unique @default(cuid())
  createdAt       DateTime   @default(now())
  updatedAt       DateTime   @updatedAt

  orderItem       OrderItem?

  @@index([recipientEmail])
  @@index([status])
  @@map("gifts")
}

// ============================================================
// Session Credits
// ============================================================
model SessionCreditBalance {
  id              String    @id @default(cuid())
  studentId       String    @unique
  student         Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  balance         Int       @default(0)
  expiresAt       DateTime?
  expiryWarning14 Boolean   @default(false)
  expiryWarning3  Boolean   @default(false)

  @@map("session_credit_balances")
}

model SessionCreditTransaction {
  id           String                @id @default(cuid())
  studentId    String
  student      Student               @relation(fields: [studentId], references: [id], onDelete: Cascade)
  type         CreditTransactionType
  amount       Int
  balanceAfter Int
  description  String
  orderId      String?
  bookingId    String?
  createdAt    DateTime              @default(now())

  @@index([studentId])
  @@map("session_credit_transactions")
}

// ============================================================
// Billing: Corporate Billing Entities
// ============================================================
model BillingEntity {
  id               String    @id @default(cuid())
  name             String
  contactPerson    String?
  email            String
  phone            String?
  vatNumber        String?
  address          String?   @db.Text
  accountReference String?

  relationships    ClientRelationship[]
  invoices         Invoice[]
  paymentRequests  PaymentRequest[]

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  @@map("billing_entities")
}

// ============================================================
// Billing: Client Relationships (family, partner, corporate links)
// ============================================================
model ClientRelationship {
  id                 String          @id @default(cuid())
  studentId          String
  student            Student         @relation("RelationshipsFrom", fields: [studentId], references: [id], onDelete: Cascade)
  relatedStudentId   String?
  relatedStudent     Student?        @relation("RelationshipsTo", fields: [relatedStudentId], references: [id], onDelete: Cascade)
  billingEntityId    String?
  billingEntity      BillingEntity?  @relation(fields: [billingEntityId], references: [id], onDelete: Cascade)
  relationshipType   String          // "partner" | "parent" | "child" | "sibling" | "guardian" | "corporate" | "other"
  relationshipLabel  String?         // Free text, e.g. "Husband", "Son", "HR Manager"
  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  // Reverse relations for billing assignment
  individualBillingFor     Student[] @relation("IndividualBilledTo")
  couplesBillingFor        Student[] @relation("CouplesBilledTo")

  @@unique([studentId, relatedStudentId])
  @@index([studentId])
  @@index([relatedStudentId])
  @@index([billingEntityId])
  @@map("client_relationships")
}

// ============================================================
// Relationship Invites (partner linking via email)
// ============================================================
model RelationshipInvite {
  id               String   @id @default(cuid())
  fromStudentId    String
  fromStudent      Student  @relation("InvitesSent", fields: [fromStudentId], references: [id], onDelete: Cascade)
  toEmail          String
  toName           String
  relationshipType String   // "partner"
  token            String   @unique @default(cuid())
  status           String   @default("pending") // "pending" | "accepted" | "declined" | "cancelled"
  toStudentId      String?
  toStudent        Student? @relation("InvitesReceived", fields: [toStudentId], references: [id], onDelete: SetNull)
  createdAt        DateTime @default(now())
  expiresAt        DateTime

  @@index([fromStudentId])
  @@index([toEmail])
  @@index([toStudentId])
  @@index([token])
  @@map("relationship_invites")
}

// ============================================================
// Billing: Invoices (universal — all payment types)
// ============================================================
model Invoice {
  id                 String          @id @default(cuid())
  invoiceNumber      String          @unique  // Format: YYYYMMDD-LT-GS-00001

  // Type determines what generated this invoice
  type               String          // "monthly_postpaid" | "package_purchase" | "course_purchase" | "product_sale" | "ad_hoc_session" | "credit_note" | "other"

  // Billing contact (who pays / who it's addressed to)
  studentId          String?
  student            Student?        @relation(fields: [studentId], references: [id], onDelete: SetNull)
  billingEntityId    String?
  billingEntity      BillingEntity?  @relation(fields: [billingEntityId], references: [id], onDelete: SetNull)

  // Snapshot at invoice creation time (denormalised — won't change if client updates profile)
  billingName        String
  billingEmail       String
  billingAddress     String?
  billingVatNumber   String?

  // Billing period (monthly postpaid only)
  periodStart        DateTime?
  periodEnd          DateTime?
  billingMonth       String?         // "2026-03" format for easy filtering

  // Financials (always ZAR)
  currency           String          @default("ZAR")
  subtotalCents      Int             // Sum of line item totals before invoice-level discount
  discountCents      Int             @default(0)  // Invoice-level discount amount
  discountPercent    Float           @default(0)  // Invoice-level discount percentage
  vatPercent         Float           @default(0)  // 0 if not VAT registered, 15 if registered
  vatAmountCents     Int             @default(0)  // Calculated: (subtotal - discount) × vatPercent / 100
  totalCents         Int             // Final amount: subtotal - discount + vat

  // Line items (stored as JSON array — see InvoiceLineItem type in lib/billing-types.ts)
  lineItems          Json            // InvoiceLineItem[]

  // Payment tracking
  status             String          @default("draft") // "draft" | "payment_requested" | "paid" | "overdue" | "cancelled" | "credited"
  paymentMethod      String?         // "paystack" | "eft" | "cash" | "card"
  paystackReference  String?
  paymentUrl         String?
  paidAt             DateTime?
  paidAmountCents    Int?
  eftReference       String?         // Manual EFT reference entered by admin

  // Source links (what triggered this invoice)
  orderId            String?         // Links to Order for e-commerce purchases
  paymentRequestId   String?         // Links to PaymentRequest for postpaid billing
  creditNoteId       String?         // Links to original invoice if this is a credit note

  // PDF storage
  pdfUrl             String?         // Supabase Storage path: invoices/{invoiceId}.pdf

  // Dates
  issuedAt           DateTime?       // When the invoice was officially issued (= payment date)
  dueDate            DateTime?       // Payment due date (postpaid only)

  // Reminder tracking (prevents duplicate sends)
  reminderSentAt     DateTime?
  overdueSentAt      DateTime?

  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  // Relations
  bookings           Booking[]       // Bookings covered by this invoice (monthly postpaid)

  @@index([studentId])
  @@index([billingEntityId])
  @@index([orderId])
  @@index([status])
  @@index([type])
  @@index([billingMonth])
  @@map("invoices")
}

// ============================================================
// Billing: Payment Requests (postpaid monthly billing — sent before payment)
// ============================================================
model PaymentRequest {
  id                 String          @id @default(cuid())

  // Who is being billed
  studentId          String?
  student            Student?        @relation(fields: [studentId], references: [id], onDelete: SetNull)
  billingEntityId    String?
  billingEntity      BillingEntity?  @relation(fields: [billingEntityId], references: [id], onDelete: SetNull)

  // Period this request covers
  billingMonth       String          // "2026-03" format
  periodStart        DateTime
  periodEnd          DateTime

  // Financials (always ZAR)
  currency           String          @default("ZAR")
  subtotalCents      Int
  discountCents      Int             @default(0)
  vatAmountCents     Int             @default(0)
  totalCents         Int
  lineItems          Json            // InvoiceLineItem[] — same structure as Invoice.lineItems

  // Payment link
  paystackReference  String?         // Set when Paystack payment link is generated
  paymentUrl         String?         // Paystack authorization_url for client to pay

  // Status
  status             String          @default("pending") // "pending" | "paid" | "overdue" | "cancelled"

  // Due date
  dueDate            DateTime

  // Tracking
  sentAt             DateTime?       // When payment request email was sent
  reminderSentAt     DateTime?       // When reminder email was sent
  overdueSentAt      DateTime?       // When overdue notice was sent
  // WhatsApp reminders
  whatsappSentAt             DateTime?
  whatsappReminderSentAt     DateTime?
  whatsappOverdueSentAt      DateTime?

  // Link to invoice (created only after payment)
  invoiceId          String?

  createdAt          DateTime        @default(now())
  updatedAt          DateTime        @updatedAt

  // Relations
  bookings           Booking[]       // Bookings included in this request

  // One payment request per client per month
  @@unique([studentId, billingMonth])
  @@unique([billingEntityId, billingMonth])
  @@index([status])
  @@index([dueDate])
  @@map("payment_requests")
}

// ============================================================
// Coupons
// ============================================================
model Coupon {
  id             String     @id @default(cuid())
  code           String     @unique
  type           CouponType
  value          Int                        // ZAR cents (fixed_amount) or percentage
  valueUsd       Int?                       // USD cents (fixed_amount only)
  valueEur       Int?                       // EUR cents (fixed_amount only)
  valueGbp       Int?                       // GBP cents (fixed_amount only)
  appliesToAll   Boolean    @default(true)
  courseIds      Json?
  packageIds    Json?
  maxUses        Int?
  usedCount      Int        @default(0)
  maxUsesPerUser Int        @default(1)
  minOrderCents  Int?
  startsAt       DateTime   @default(now())
  expiresAt      DateTime?
  isActive       Boolean    @default(true)
  createdAt      DateTime   @default(now())
  updatedAt      DateTime   @updatedAt

  orders         Order[]

  @@map("coupons")
}

// ============================================================
// Shopping Cart (DB-persisted for logged-in students)
// ============================================================
model Cart {
  id        String     @id @default(cuid())
  studentId String     @unique
  student   Student    @relation(fields: [studentId], references: [id], onDelete: Cascade)
  updatedAt DateTime   @updatedAt

  items     CartItem[]

  @@map("carts")
}

model CartItem {
  id                 String          @id @default(cuid())
  cartId             String
  cart               Cart            @relation(fields: [cartId], references: [id], onDelete: Cascade)
  courseId            String?
  hybridPackageId    String?
  moduleId           String?
  digitalProductId   String?
  digitalProduct     DigitalProduct? @relation(fields: [digitalProductId], references: [id])
  packageSelections  Json?           // { courseIds: string[], digitalProductIds: string[] }
  quantity           Int             @default(1)
  isGift             Boolean         @default(false)
  giftRecipientName  String?
  giftRecipientEmail String?
  giftMessage        String?         @db.Text
  giftDeliveryDate   DateTime?
  addedAt            DateTime        @default(now())

  @@index([cartId])
  @@map("cart_items")
}

// ============================================================
// Packages (unified: course bundles, credit packs, hybrids, digital docs)
// ============================================================
model HybridPackage {
  id                  String   @id @default(cuid())
  title               String
  slug                String   @unique
  description         String?  @db.Text
  imageUrl            String?
  priceCents          Int
  priceCentsUsd       Int?
  priceCentsEur       Int?
  priceCentsGbp       Int?
  credits             Int      @default(0)
  courseSlots          Int      @default(0) // How many full courses the customer picks
  digitalProductSlots Int      @default(0) // How many digital products the customer picks
  isPublished         Boolean  @default(false)
  sortOrder           Int      @default(0)
  metaTitle           String?
  metaDescription     String?  @db.Text
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  orderItems  OrderItem[]
  gifts       Gift[]

  @@map("hybrid_packages")
}

// ============================================================
// Digital Products (downloadable files: PDFs, workbooks, etc.)
// ============================================================
model DigitalProduct {
  id             String   @id @default(cuid())
  title          String
  slug           String   @unique
  description    String?  @db.Text
  imageUrl       String?
  fileUrl        String   // Private Supabase Storage path (e.g. "products/abc123.pdf")
  fileName       String?  // Original filename for display
  fileSizeBytes  Int?     // File size in bytes
  priceCents     Int      @default(0)  // ZAR cents
  priceCentsUsd  Int?     // USD cents
  priceCentsEur  Int?     // EUR cents
  priceCentsGbp  Int?     // GBP cents
  category       String?  // workbook, toolkit, guide, journal, cheat_sheet (for future filtering)
  isPublished    Boolean  @default(false)
  sortOrder      Int      @default(0)
  metaTitle      String?
  metaDescription String?  @db.Text
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  access     DigitalProductAccess[]
  orderItems OrderItem[]
  gifts      Gift[]
  cartItems  CartItem[]

  @@map("digital_products")
}

// ============================================================
// Digital Product Access (tracks student ownership)
// ============================================================
model DigitalProductAccess {
  id               String           @id @default(cuid())
  studentId        String
  student          Student          @relation(fields: [studentId], references: [id], onDelete: Cascade)
  digitalProductId String
  digitalProduct   DigitalProduct   @relation(fields: [digitalProductId], references: [id], onDelete: Cascade)
  orderId          String?
  source           EnrollmentSource @default(purchase)
  grantedAt        DateTime         @default(now())

  @@unique([studentId, digitalProductId])
  @@index([studentId])
  @@index([digitalProductId])
  @@map("digital_product_access")
}

// ============================================================
// Email Templates (admin-editable, DB-stored)
// ============================================================
model EmailTemplate {
  id        String   @id @default(cuid())
  key       String   @unique // "booking_confirmation", "order_confirmation", etc.
  name      String           // Human-readable name
  category  String           // "booking" | "order" | "onboarding" | "course" | "gift"
  subject   String           // Subject line with {{variable}} placeholders
  bodyHtml  String   @db.Text // Inner HTML body with {{variable}} placeholders
  variables Json             // Array of available variable names
  isActive  Boolean  @default(true)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@map("email_templates")
}

// ============================================================
// Email Delivery Log
// ============================================================
model EmailLog {
  id           String    @id @default(cuid())
  templateKey  String?   // e.g. "booking_confirmation"
  to           String
  subject      String
  status       String    // "sent" | "failed"
  error        String?   @db.Text
  studentId    String?
  student      Student?  @relation(fields: [studentId], references: [id], onDelete: SetNull)
  metadata     Json?     // Extra context: bookingId, orderId, giftId, etc.
  sentAt       DateTime  @default(now())
  trackingId   String?   @unique // Unique token for open/click tracking
  openedAt     DateTime? // First open timestamp
  opensCount   Int       @default(0)
  clickedAt    DateTime? // First click timestamp
  clicksCount  Int       @default(0)

  @@index([to])
  @@index([templateKey])
  @@index([studentId])
  @@index([sentAt])
  @@map("email_logs")
}

// ============================================================
// Campaigns (email broadcasts)
// ============================================================
model Campaign {
  id              String             @id @default(cuid())
  name            String
  subject         String?            // Legacy single-email campaigns
  bodyHtml        String?            @db.Text
  status          CampaignStatus     @default(draft)
  isMultiStep     Boolean            @default(false)
  filterSource       String?       // Legacy — use audienceFilters instead
  filterClientStatus String?       // Legacy — use audienceFilters instead
  filterTags         Json?         // Legacy — use audienceFilters instead
  audienceFilters    Json?         // New: AudienceFilters object
  campaignType    String             @default("standard") // "standard" | "birthday"
  totalRecipients Int                @default(0)
  sentCount       Int                @default(0)
  failedCount     Int                @default(0)
  sentAt          DateTime?          // Legacy: when single-send completed
  sentById        String?
  startDate       DateTime?          // When cron should activate
  activatedAt     DateTime?          // When cron flipped to active
  completedAt     DateTime?          // When all steps finished
  createdAt       DateTime           @default(now())
  updatedAt       DateTime           @updatedAt
  emails          CampaignEmail[]
  progress        CampaignProgress[]

  @@index([status])
  @@index([startDate])
  @@map("campaigns")
}

model CampaignEmail {
  id          String   @id @default(cuid())
  campaignId  String
  campaign    Campaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  step        Int
  dayOffset   Int
  subject     String
  previewText String?
  bodyHtml    String   @db.Text
  ctaText     String?
  ctaUrl      String?
  genderTarget String?               // "female" | "male" | "unknown" — birthday campaigns only
  isActive    Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@unique([campaignId, step])
  @@index([campaignId])
  @@map("campaign_emails")
}

model CampaignProgress {
  id          String    @id @default(cuid())
  campaignId  String
  campaign    Campaign  @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  studentId   String
  student     Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)
  currentStep Int       @default(0)
  lastSentAt  DateTime?
  completedAt DateTime?
  isPaused    Boolean   @default(false)
  createdAt   DateTime  @default(now())
  updatedAt   DateTime  @updatedAt

  @@unique([campaignId, studentId])
  @@index([campaignId, completedAt])
  @@index([studentId])
  @@map("campaign_progress")
}

// ============================================================
// Drip Emails (automated nurture sequence)
// ============================================================
model DripEmail {
  id          String        @id @default(cuid())
  type        DripEmailType
  step        Int
  dayOffset   Int
  subject     String
  previewText String?
  bodyHtml    String        @db.Text
  ctaText     String?
  ctaUrl      String?
  isActive    Boolean       @default(true)
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@unique([type, step])
  @@index([type])
  @@map("drip_emails")
}

model DripProgress {
  id           String        @id @default(cuid())
  studentId    String        @unique
  student      Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  currentPhase DripEmailType @default(onboarding)
  currentStep  Int           @default(0)
  lastSentAt   DateTime?
  completedAt  DateTime?
  isPaused     Boolean       @default(false)
  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  @@index([currentPhase, currentStep])
  @@index([isPaused])
  @@map("drip_progress")
}

// ============================================================
// Page SEO (per-route meta tags, client-manageable)
// ============================================================
model PageSeo {
  id              String   @id @default(cuid())
  route           String   @unique // e.g. "/about", "/courses", "/"
  metaTitle       String?
  metaDescription String?  @db.Text
  ogImageUrl      String?
  keywords        String?
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  @@map("page_seo")
}

// ============================================================
// Client Intake (Assessment — behaviours, feelings, symptoms)
// ============================================================
model ClientIntake {
  id              String    @id @default(cuid())
  studentId       String    @unique
  student         Student   @relation(fields: [studentId], references: [id], onDelete: Cascade)

  // Checklist arrays
  behaviours      String[]  @default([])
  feelings        String[]  @default([])
  symptoms        String[]  @default([])

  // Free text
  otherBehaviours String?
  otherFeelings   String?
  otherSymptoms   String?
  additionalNotes String?   @db.Text
  adminNotes      String?   @db.Text  // Admin-only, not visible to client

  // Tracking
  lastEditedBy    String?   // "client" | "admin"
  lastEditedAt    DateTime  @default(now())
  completedAt     DateTime?
  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@map("client_intakes")
}

// ============================================================
// DEPRECATED: Legacy Commitment Acknowledgement
// TODO: Remove after confirming migration to document_acceptances — keep 1 release
// Replaced by LegalDocument + DocumentAcceptance system (Phase 5B)
// ============================================================
model CommitmentAcknowledgement {
  id             String   @id @default(cuid())
  studentId      String
  student        Student  @relation(fields: [studentId], references: [id], onDelete: Cascade)
  version        String   @default("v1")
  ipAddress      String?
  userAgent      String?
  acknowledgedAt DateTime @default(now())

  @@unique([studentId, version])
  @@map("commitment_acknowledgements")
}

// ============================================================
// Legal Documents (versioned, admin-managed)
// ============================================================
model LegalDocument {
  id             String    @id @default(cuid())
  slug           String    // "commitment" | "terms" | "privacy"
  title          String
  content        Json      // Array of { heading: string, content: string }
  version        Int       @default(1)
  changeSummary  String?
  publishedAt    DateTime?
  isActive       Boolean   @default(false)
  createdBy      String?
  createdAt      DateTime  @default(now())
  updatedAt      DateTime  @updatedAt

  acceptances    DocumentAcceptance[]

  @@unique([slug, version])
  @@index([slug, isActive])
  @@map("legal_documents")
}

model DocumentAcceptance {
  id              String        @id @default(cuid())
  studentId       String
  student         Student       @relation(fields: [studentId], references: [id], onDelete: Cascade)
  documentId      String
  document        LegalDocument @relation(fields: [documentId], references: [id], onDelete: Cascade)
  documentSlug    String        // denormalised for quick queries
  documentVersion Int           // denormalised for quick queries
  ipAddress       String?
  userAgent       String?
  acceptedAt      DateTime      @default(now())

  @@unique([studentId, documentSlug, documentVersion])
  @@index([studentId, documentSlug])
  @@map("document_acceptances")
}

// ============================================================
// WhatsApp Message Log
// ============================================================
model WhatsAppLog {
  id           String   @id @default(cuid())
  templateName String
  to           String
  studentId    String?
  student      Student? @relation(fields: [studentId], references: [id], onDelete: SetNull)
  waMessageId  String?
  status       String   @default("sent")
  error        String?
  metadata     Json?
  sentAt       DateTime @default(now())

  @@index([studentId])
  @@index([templateName])
  @@index([sentAt])
  @@map("whatsapp_logs")
}

// ============================================================
// WhatsApp: Message template definitions (reference for Meta)
// ============================================================
model WhatsAppTemplate {
  id          String   @id @default(cuid())
  name        String   @unique
  bodyText    String
  description String?
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@map("whatsapp_templates")
}
